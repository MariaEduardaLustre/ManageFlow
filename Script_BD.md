-- Script para criação do banco de dados.

CREATE DATABASE manageFlow;
USE manageFlow;

-- Tabela Usuario
CREATE TABLE Usuario (
    ID INT AUTO_INCREMENT PRIMARY KEY,
    NOME TEXT NOT NULL,
    EMAIL VARCHAR(255) UNIQUE NOT NULL,
    CPF VARCHAR(11) UNIQUE NOT NULL,
    DDI VARCHAR(3),
    DDD VARCHAR(3),
    TELEFONE VARCHAR(9),
    ENDERECO TEXT,
    NUMERO INT,
    SENHA VARCHAR(255) NOT NULL
);

-- Tabela Empresa
CREATE TABLE Empresa (
    ID_EMPRESA INT AUTO_INCREMENT PRIMARY KEY,
    NOME_EMPRESA TEXT NOT NULL,
    EMAIL VARCHAR(100) UNIQUE NOT NULL,
    CNPJ VARCHAR(14) UNIQUE NOT NULL,
    DDI VARCHAR(3),
    DDD VARCHAR(3),
    TELEFONE VARCHAR(9),
    ENDERECO TEXT,
    NUMERO INT,
    LOGO TEXT
);

-- Tabela Perfil
CREATE TABLE Perfil (
    ID_PERFIL INT AUTO_INCREMENT PRIMARY KEY,
    NOME_PERFIL TEXT NOT NULL,
    ID_EMPRESA INT NOT NULL,
    NIVEL INT NOT NULL,
    FOREIGN KEY (ID_EMPRESA) REFERENCES Empresa(ID_EMPRESA)
);

-- Tabela Empresa_Perfil_Usuario
CREATE TABLE Empresa_Perfil_Usuario (
    ID_EMPRESA INT NOT NULL,
    ID_PERFIL INT NOT NULL,
    ID_USUARIO INT NOT NULL,
    NIVEL INT NOT NULL,
    PRIMARY KEY (ID_EMPRESA, ID_PERFIL, ID_USUARIO),
    FOREIGN KEY (ID_EMPRESA) REFERENCES Empresa(ID_EMPRESA),
    FOREIGN KEY (ID_PERFIL) REFERENCES Perfil(ID_PERFIL),
    FOREIGN KEY (ID_USUARIO) REFERENCES Usuario(ID)
);

-- Tabela ConfiguracaoFila
CREATE TABLE ConfiguracaoFila (
    ID_CONF_FILA INT AUTO_INCREMENT PRIMARY KEY,
    ID_EMPRESA INT NOT NULL,
    NOME_FILA TEXT NOT NULL,
    TOKEN_FILA VARCHAR(100) UNIQUE NOT NULL,
    INI_VIG INT NOT NULL,
    FIM_VIG INT,
    CAMPOS JSON,
    MENSAGEM TEXT,
    IMG_BANNER JSON,
    TEMP_TOL INT,
    QDTE_MIN INT,
    QTDE_MAX INT,
    PER_SAIR BOOLEAN NOT NULL,
    PER_LOC BOOLEAN NOT NULL,
    SITUACAO INT NOT NULL,
    FOREIGN KEY (ID_EMPRESA) REFERENCES Empresa(ID_EMPRESA)
);

-- Tabela Fila
CREATE TABLE Fila (
    ID_FILA INT AUTO_INCREMENT PRIMARY KEY,
    ID_EMPRESA INT NOT NULL,
    DT_MOVTO DATE NOT NULL,
    DT_INI DATE NOT NULL,
    DT_FIM DATE NOT NULL,
    DT_INATIV TIMESTAMP,
    ID_CONF_FILA INT NOT NULL,
    BLOCK BOOLEAN NOT NULL,
    SITUACAO INT NOT NULL,
    FOREIGN KEY (ID_EMPRESA) REFERENCES Empresa(ID_EMPRESA),
    FOREIGN KEY (ID_CONF_FILA) REFERENCES ConfiguracaoFila(ID_CONF_FILA)
);

-- Tabela Horarios
CREATE TABLE Horarios (
    ID_EMPRESA INT NOT NULL,
    ID_CONF_FILA INT NOT NULL,
    ID_FILA INT NOT NULL,
    DIA_SEM INT NOT NULL,
    SEQ_TURNO INT NOT NULL,
    HR_INICIO TIME NOT NULL,
    HR_FIM TIME NOT NULL,
    SITUACAO INT NOT NULL,
    PRIMARY KEY (ID_EMPRESA, ID_CONF_FILA, ID_FILA, DIA_SEM, SEQ_TURNO),
    FOREIGN KEY (ID_EMPRESA) REFERENCES Empresa(ID_EMPRESA),
    FOREIGN KEY (ID_CONF_FILA) REFERENCES ConfiguracaoFila(ID_CONF_FILA),
    FOREIGN KEY (ID_FILA) REFERENCES Fila(ID_FILA)
);

-- Tabela Fila_Horarios
CREATE TABLE Fila_Horarios (
    ID_EMPRESA INT NOT NULL,
    DT_MOVTO DATE NOT NULL,
    ID_FILA INT NOT NULL,
    DT_INI TIMESTAMP NOT NULL,
    DT_FIM TIMESTAMP NOT NULL,
    DT_INATIV TIMESTAMP,
    ID_CONF_FILA INT NOT NULL,
    BLOCK BOOLEAN NOT NULL,
    SITUACAO INT NOT NULL,
    PRIMARY KEY (ID_EMPRESA, DT_MOVTO, ID_FILA),
    FOREIGN KEY (ID_EMPRESA) REFERENCES Empresa(ID_EMPRESA),
    FOREIGN KEY (ID_CONF_FILA) REFERENCES ConfiguracaoFila(ID_CONF_FILA),
    FOREIGN KEY (ID_FILA) REFERENCES Fila(ID_FILA)
);

-- Tabela ClientesFila
CREATE TABLE ClientesFila (
    ID_EMPRESA INT NOT NULL,
    DT_MOVTO DATE NOT NULL,
    ID_FILA INT NOT NULL,
    ID_CLIENTE INT NOT NULL,
    CPFCNPJ VARCHAR(15),
    RG VARCHAR(15),
    NOME VARCHAR(120),
    DT_NASC DATE,
    EMAIL VARCHAR(150),
    NR_QTDPES INT,
    DDDCEL VARCHAR(3),
    NR_CEL VARCHAR(10),
    CAMPOS JSON,
    DT_ENTRA TIMESTAMP NOT NULL,
    DT_CHAMA TIMESTAMP,
    DT_LIMAPRE TIMESTAMP,
    DT_APRE TIMESTAMP,
    DT_SAIDA TIMESTAMP,
    DV133_NR_USRDEL INT,
    SITUACAO INT NOT NULL,
    PRIMARY KEY (ID_EMPRESA, DT_MOVTO, ID_FILA, ID_CLIENTE),
    FOREIGN KEY (ID_EMPRESA) REFERENCES Empresa(ID_EMPRESA),
    FOREIGN KEY (ID_FILA) REFERENCES Fila(ID_FILA)
);

-- Tabela Log
CREATE TABLE Log (
    DT_OCOR DATE NOT NULL,
    SEQ_LOG INT NOT NULL,
    DH_OCOR TIMESTAMP NOT NULL,
    TP_OCOR INT NOT NULL,
    ID_EMPRESA INT NOT NULL,
    DT_MOVTO DATE NOT NULL,
    ID_FILA INT NOT NULL,
    ID_CLIENTE INT,
    CLIENTE TEXT,
    CD_RESULT INT,
    VC_RESULT TEXT,
    PRIMARY KEY (DT_OCOR, SEQ_LOG),
    FOREIGN KEY (ID_EMPRESA, DT_MOVTO, ID_FILA, ID_CLIENTE)
        REFERENCES ClientesFila(ID_EMPRESA, DT_MOVTO, ID_FILA, ID_CLIENTE)
<<<<<<< HEAD
);
=======
);

-- MUDANÇAS TABELA USUARIO
ALTER TABLE Usuario
ADD COLUMN resetPasswordToken VARCHAR(255) NULL,
ADD COLUMN resetPasswordExpires DATETIME NULL;
>>>>>>> develop
